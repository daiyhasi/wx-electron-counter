# ============================================================
# GitHub Actions â€” Electron åº”ç”¨åŒç«¯æ„å»ºå·¥ä½œæµ
# åœ¨ macOS å’Œ Windows ä¸Šæ„å»ºå®‰è£…åŒ…
# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
# ============================================================

name: Build Electron App

on:
  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Releaseï¼ˆè‰ç¨¿ï¼‰'
        required: false
        type: boolean
        default: false

# ---------- å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯ä»…ä¿ç•™æœ€æ–°çš„æ„å»º ----------
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

# ---------- å…¨å±€æƒé™ ----------
permissions:
  contents: write  # ç”¨äº Release ä¸Šä¼ 

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------- macOS æ„å»º ----------
          - os: macos-latest
            platform: mac
          # ---------- Windows æ„å»º ----------
          - os: windows-latest
            platform: win

    runs-on: ${{ matrix.os }}
    name: æ„å»º (${{ matrix.platform }})

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. å®‰è£… Node.js
      - name: ğŸ“¦ å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      # 4. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ï¼ˆå°† git commit hash å†™å…¥ version.jsonï¼‰
      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        run: node scripts/update-version.cjs

      # 5. æ„å»ºå‰ç«¯ + Electronï¼ˆvite-plugin-electron è‡ªåŠ¨å¤„ç†ä¸»è¿›ç¨‹å’Œé¢„åŠ è½½è„šæœ¬ï¼‰
      - name: ğŸ”¨ æ„å»ºåº”ç”¨
        run: npx vite build

      # 6. æ‰“åŒ… Electron åº”ç”¨ (macOS)
      - name: ğŸ“¦ æ‰“åŒ… Electron åº”ç”¨ (macOS)
        if: matrix.platform == 'mac'
        run: npx electron-builder --mac --config electron-builder.json5 --publish never
        env:
          # è·³è¿‡ç­¾åï¼ˆCI ä¸­æš‚ä¸ç­¾åï¼‰
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'

      # 6. æ‰“åŒ… Electron åº”ç”¨ (Windows)
      - name: ğŸ“¦ æ‰“åŒ… Electron åº”ç”¨ (Windows)
        if: matrix.platform == 'win'
        run: npx electron-builder --win --config electron-builder.json5 --publish never

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: electron-app-${{ matrix.platform }}
          path: |
            release/*.dmg
            release/*.exe
            release/*.yml
            release/*.blockmap
          if-no-files-found: error
          retention-days: 30

  # ---------- åˆ›å»º Releaseï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶å¯é€‰ï¼‰ ----------
  release:
    needs: build
    if: ${{ inputs.create_release == true }}
    runs-on: ubuntu-latest
    name: ğŸ“‹ åˆ›å»º Release

    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.yml
